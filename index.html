<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>找色挑戰 · Mobile HUD</title>
<style>
  :root { --bg:#0f1115; --panel:#181b22; --text:#e7eef7; --muted:#9aa3af; --accent:#79c0ff; }
  *{box-sizing:border-box}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family: ui-sans-serif, -apple-system, "Noto Sans TC", "Segoe UI", Roboto, Arial;
    display:grid; grid-template-rows:auto 1fr auto; min-height:100dvh;
  }
  header, footer{padding:12px 16px; background:#0b0d11; border-bottom:1px solid #20242c}
  footer{border-top:1px solid #20242c; border-bottom:none; color:var(--muted); font-size:12px}

  main{padding:12px; display:grid; gap:12px}

  /* Camera block */
  .camCard{position:relative; border:1px solid #232832; border-radius:12px; overflow:hidden; background:var(--panel)}
  .camera{position:relative; aspect-ratio:3/4; display:grid; place-items:center}
  video{width:100%; height:100%; object-fit:cover; display:block}

  /* Aim box */
  .aim{position:absolute; inset:0; pointer-events:none; display:grid; place-items:center}
  .aim::before{
    content:""; width:44%; aspect-ratio:1/1; border-radius:12px;
    outline:2px dashed rgba(255,255,255,.35); outline-offset:-8px;
    box-shadow: inset 0 0 0 9999px rgba(0,0,0,.12);
  }

  /* HUD (mobile first) */
  .hud{
    position:absolute; left:8px; right:8px; top:8px; display:flex; gap:8px; flex-wrap:wrap;
    z-index:3;
  }
  .chip{
    display:flex; align-items:center; gap:8px; padding:8px 10px;
    border:1px solid #2a3342; border-radius:12px;
    background:rgba(12,15,20,.6); -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px);
  }
  .mini{width:28px; height:28px; border-radius:6px; border:1px solid #2a3342; background:#111}
  .label{font-size:12px; color:#cfe6ff}
  .val{font-weight:700; font-size:12px}
  .score{
    margin-left:auto; display:flex; align-items:baseline; gap:8px; padding:8px 10px;
    border:1px solid #2a3342; border-radius:12px; background:rgba(12,15,20,.6);
  }
  .big{font-size:26px; font-weight:800; letter-spacing:.3px}
  .timer{font-variant-numeric:tabular-nums}

  /* HUD bottom controls */
  .hudCtrl{
    position:absolute; right:8px; bottom:8px; display:flex; gap:8px; z-index:3;
  }
  button{
    appearance:none; border:1px solid #2a3342; background:#0f131a; color:var(--text);
    padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer;
  }
  .primary{background:linear-gradient(180deg,#1a8cff,#0066ff); border-color:#175bba}
  button:disabled{opacity:.6; cursor:not-allowed}

  /* Details drawer (collapsible on mobile) */
  details{border:1px solid #232832; border-radius:12px; background:var(--panel); overflow:hidden}
  summary{padding:12px 14px; cursor:pointer}
  .body{padding:12px 14px; display:grid; gap:10px}
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .swatch{height:72px; border-radius:10px; border:1px solid #2a3342; background:#000}
  .meta{font-size:12px; color:var(--muted)}
  .tag{font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #2a3342; background:#0f131a; color:#cfe6ff}
  .scoreline{display:flex; gap:10px; align-items:baseline; flex-wrap:wrap}

  /* Desktop: keep two-column info open */
  @media(min-width:900px){
    main{grid-template-columns:1.2fr 1fr; align-items:start}
    details[open]{display:block}
    summary{display:none}
  }

  canvas{display:none}
</style>
</head>
<body>
<header><strong>找色挑戰 · Color Match</strong></header>

<main>
  <!-- Left: Camera with HUD -->
  <section class="camCard">
    <div class="camera">
      <video id="video" autoplay playsinline muted></video>
      <div class="aim"></div>

      <!-- HUD top -->
      <div class="hud">
        <div class="chip">
          <div class="mini" id="hudTarget"></div>
          <div>
            <div class="label">目標</div>
            <div class="val" id="hudTargetHex">—</div>
          </div>
        </div>
        <div class="chip">
          <div class="mini" id="hudShot"></div>
          <div>
            <div class="label">你的拍攝</div>
            <div class="val" id="hudShotHex">—</div>
          </div>
        </div>
        <div class="score">
          <span class="timer">倒數 <span id="timeLeft">15.0</span>s</span>
          <span class="big" id="score">0</span>
        </div>
      </div>

      <!-- HUD bottom buttons -->
      <div class="hudCtrl">
        <button id="btnStart" class="primary">開始鏡頭</button>
        <button id="btnNew" title="換一個目標色">換題</button>
        <button id="btnCapture">拍照</button>
        <button id="btnNext">下一回合</button>
      </div>
    </div>
  </section>

  <!-- Right (or below on mobile): details / results -->
  <section>
    <details open>
      <summary>顏色與結果（點我展開/收合）</summary>
      <div class="body">
        <div class="meta">回合：<span id="roundNow">1</span>/<span id="roundMax">3</span>　｜　隱私：影像僅本機比對，不上傳。</div>
        <div class="grid">
          <div>
            <div class="meta">目標色</div>
            <div id="targetSwatch" class="swatch"></div>
            <div id="targetHex" style="font-weight:700; margin-top:6px;">—</div>
            <div id="targetHsl" class="meta">—</div>
          </div>
          <div>
            <div class="meta">你的拍攝</div>
            <div id="shotSwatch" class="swatch"></div>
            <div id="shotHex" style="font-weight:700; margin-top:6px;">—</div>
            <div id="shotHsl" class="meta">—</div>
          </div>
        </div>
        <div class="scoreline">
          <span class="tag" id="deltaE">ΔE —</span>
          <span class="tag" id="judgement">尚未判定</span>
        </div>
      </div>
    </details>
  </section>

  <canvas id="canvas" width="720" height="960"></canvas>
</main>

<footer>小技巧：避開過亮/過暗；將中央框對準顏色較均勻的區域更容易高分。</footer>

<script>
(function(){
  /** DOM **/
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d', { willReadFrequently: true });

  const btnStart = document.getElementById('btnStart');
  const btnNew = document.getElementById('btnNew');
  const btnCapture = document.getElementById('btnCapture');
  const btnNext = document.getElementById('btnNext');

  // HUD
  const hudTarget = document.getElementById('hudTarget');
  const hudTargetHex = document.getElementById('hudTargetHex');
  const hudShot = document.getElementById('hudShot');
  const hudShotHex = document.getElementById('hudShotHex');
  const scoreEl = document.getElementById('score');
  const timeLeftEl = document.getElementById('timeLeft');

  // Detail cards
  const targetSwatch = document.getElementById('targetSwatch');
  const targetHex = document.getElementById('targetHex');
  const targetHsl = document.getElementById('targetHsl');
  const shotSwatch = document.getElementById('shotSwatch');
  const shotHex = document.getElementById('shotHex');
  const shotHsl = document.getElementById('shotHsl');
  const deltaEEl = document.getElementById('deltaE');
  const judgeEl = document.getElementById('judgement');
  const roundNowEl = document.getElementById('roundNow');
  const roundMaxEl = document.getElementById('roundMax');

  /** State **/
  const ROUND_MAX = 3;
  const TIME_PER_ROUND = 15.0;
  let roundNow = 1;
  let stream = null;
  let timer = null;
  let target = null;
  let lastShot = null;

  /** Color utils **/
  function rgbToHex({r,g,b}){ return '#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('').toUpperCase(); }
  function rgbToHsl({r,g,b}) {
    r/=255; g/=255; b/=255;
    const max=Math.max(r,g,b), min=Math.min(r,g,b);
    let h=0,s=0,l=(max+min)/2;
    if(max!==min){
      const d=max-min;
      s=l>0.5? d/(2-max-min): d/(max+min);
      switch(max){
        case r:h=(g-b)/d+(g<b?6:0);break;
        case g:h=(b-r)/d+2;break;
        case b:h=(r-g)/d+4;break;
      }
      h/=6;
    }
    return {h:Math.round(h*360), s:Math.round(s*100), l:Math.round(l*100)};
  }
  function srgbToX(v){ return (v<=0.04045)? v/12.92 : Math.pow((v+0.055)/1.055,2.4); }
  function rgbToLab({r,g,b}){
    let R=srgbToX(r/255), G=srgbToX(g/255), B=srgbToX(b/255);
    let X=R*0.4124564+G*0.3575761+B*0.1804375;
    let Y=R*0.2126729+G*0.7151522+B*0.0721750;
    let Z=R*0.0193339+G*0.1191920+B*0.9503041;
    const Xn=0.95047, Yn=1.00000, Zn=1.08883;
    function f(t){ return t>0.008856? Math.cbrt(t) : (7.787*t+16/116); }
    let fx=f(X/Xn), fy=f(Y/Yn), fz=f(Z/Zn);
    return {L:116*fy-16, a:500*(fx-fy), b:200*(fy-fz)};
  }
  function ciede2000(l1,l2){
    const {L:L1,a:a1,b:b1}=l1, {L:L2,a:a2,b:b2}=l2;
    const kL=1,kC=1,kH=1;
    const C1=Math.hypot(a1,b1), C2=Math.hypot(a2,b2), Cbar=(C1+C2)/2;
    const G=0.5*(1-Math.sqrt(Math.pow(Cbar,7)/(Math.pow(Cbar,7)+Math.pow(25,7))));
    const a1p=(1+G)*a1, a2p=(1+G)*a2;
    const C1p=Math.hypot(a1p,b1), C2p=Math.hypot(a2p,b2);
    const h1p=(Math.atan2(b1,a1p)*180/Math.PI+360)%360;
    const h2p=(Math.atan2(b2,a2p)*180/Math.PI+360)%360;
    const dLp=L2-L1, dCp=C2p-C1p;
    let dhp;
    if(C1p*C2p===0) dhp=0;
    else{
      const diff=h2p-h1p;
      dhp = Math.abs(diff)<=180 ? diff : (diff>180? diff-360 : diff+360);
    }
    const dHp=2*Math.sqrt(C1p*C2p)*Math.sin((dhp/2)*Math.PI/180);
    const Lbar=(L1+L2)/2, Cpbar=(C1p+C2p)/2;
    let hpbar;
    if(C1p*C2p===0) hpbar=h1p+h2p;
    else{
      const diff=Math.abs(h1p-h2p);
      hpbar = diff<=180 ? (h1p+h2p)/2 : (h1p+h2p+360)/2 - ((h1p+h2p)>=360?360:0);
    }
    const T=1-0.17*Math.cos((hpbar-30)*Math.PI/180)+0.24*Math.cos((2*hpbar)*Math.PI/180)
            +0.32*Math.cos((3*hpbar+6)*Math.PI/180)-0.20*Math.cos((4*hpbar-63)*Math.PI/180);
    const Sl=1+(0.015*Math.pow(Lbar-50,2))/Math.sqrt(20+Math.pow(Lbar-50,2));
    const Sc=1+0.045*Cpbar;
    const Sh=1+0.015*Cpbar*T;
    const dTheta=30*Math.exp(-Math.pow((hpbar-275)/25,2));
    const Rc=2*Math.sqrt(Math.pow(Cpbar,7)/(Math.pow(Cpbar,7)+Math.pow(25,7)));
    const Rt=-Rc*Math.sin(2*dTheta*Math.PI/180);
    const dE=Math.sqrt(
      Math.pow(dLp/(kL*Sl),2)+Math.pow(dCp/(kC*Sc),2)+Math.pow(dHp/(kH*Sh),2)
      + Rt*(dCp/(kC*Sc))*(dHp/(kH*Sh))
    );
    return dE;
  }
  function scoreFromDeltaE(dE){ return Math.round(100*Math.exp(-Math.pow(dE/15,2))); }
  function judgeFromDeltaE(dE){
    if(dE<2) return "幾乎一樣 😲";
    if(dE<5) return "非常接近 🔥";
    if(dE<10) return "不錯了 👍";
    if(dE<20) return "還可以 👀";
    return "再試試看～ 💪";
  }
  function hslToRgb(h,s,l){
    s/=100; l/=100;
    const c=(1-Math.abs(2*l-1))*s, hp=h/60, x=c*(1-Math.abs(hp%2-1));
    let r1=0,g1=0,b1=0;
    if(0<=hp&&hp<1){r1=c;g1=x}
    else if(1<=hp&&hp<2){r1=x;g1=c}
    else if(2<=hp&&hp<3){g1=c;b1=x}
    else if(3<=hp&&hp<4){g1=x;b1=c}
    else if(4<=hp&&hp<5){r1=x;b1=c}
    else if(5<=hp&&hp<=6){r1=c;b1=x}
    const m=l-c/2;
    return {r:Math.round((r1+m)*255), g:Math.round((g1+m)*255), b:Math.round((b1+m)*255)};
  }
  function randomTargetColor(){
    const h=Math.floor(Math.random()*360);
    const s=Math.floor(55+Math.random()*35);
    const l=Math.floor(40+Math.random()*25);
    const rgb=hslToRgb(h,s,l);
    return {rgb, hsl:{h,s,l}};
  }

  /** Capture average of center box */
  function captureCenterAverage(ratio=0.44){
    const vw = video.videoWidth || 720;
    const vh = video.videoHeight || 960;
    canvas.width = vw; canvas.height = vh;
    ctx.drawImage(video,0,0,vw,vh);
    const bw=Math.floor(vw*ratio), bh=Math.floor(vh*ratio);
    const x0=Math.floor((vw-bw)/2), y0=Math.floor((vh-bh)/2);
    const img=ctx.getImageData(x0,y0,bw,bh).data;
    let r=0,g=0,b=0,cnt=0;
    for(let i=0;i<img.length;i+=4){
      const R=img[i], G=img[i+1], B=img[i+2];
      const L=0.2126*R+0.7152*G+0.0722*B;
      if(L<10||L>245) continue; // ignore extreme
      r+=R; g+=G; b+=B; cnt++;
    }
    if(!cnt) return {r:0,g:0,b:0};
    return {r:Math.round(r/cnt), g:Math.round(g/cnt), b:Math.round(b/cnt)};
  }

  /** UI sync **/
  function setTarget({rgb,hsl}){
    target = rgb;
    const hex = rgbToHex(rgb);
    // HUD
    hudTarget.style.background = hex;
    hudTargetHex.textContent = hex;
    // Card
    targetSwatch.style.background = hex;
    targetHex.textContent = hex;
    targetHsl.textContent = `HSL(${hsl.h}, ${hsl.s}%, ${hsl.l}%)`;
  }
  function setShot(rgb){
    lastShot = rgb;
    const hex = rgbToHex(rgb);
    hudShot.style.background = hex;
    hudShotHex.textContent = hex;
    shotSwatch.style.background = hex;
    shotHex.textContent = hex;
    const hsl = rgbToHsl(rgb);
    shotHsl.textContent = `HSL(${hsl.h}, ${hsl.s}%, ${hsl.l}%)`;
  }
  function resetShot(){
    setShot({r:17,g:17,b:17});
    scoreEl.textContent = "0";
    deltaEEl.textContent = "ΔE —";
    judgeEl.textContent = "尚未判定";
  }

  /** Timer **/
  let raf=null;
  function startTimer(){
    stopTimer();
    const T = TIME_PER_ROUND;
    const t0 = performance.now();
    function tick(t){
      const remain = Math.max(0, T - (t - t0)/1000);
      timeLeftEl.textContent = remain.toFixed(1);
      if(remain<=0){ stopTimer(); btnCapture.disabled=true; judgeEl.textContent="時間到 ⏱️"; return; }
      raf = requestAnimationFrame(tick);
    }
    raf = requestAnimationFrame(tick);
  }
  function stopTimer(){ if(raf) cancelAnimationFrame(raf); raf=null; }

  /** Camera **/
  async function startCamera(){
    if(stream) return;
    try{
      stream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:{ideal:'environment'}, width:{ideal:1280}, height:{ideal:1920} },
        audio:false
      });
      video.srcObject = stream; await video.play();
    }catch(e){
      alert("無法開啟鏡頭，請確認權限與 HTTPS。"); console.error(e);
    }
  }

  /** Rounds **/
  const ROUND_MAX_VAL = 3;
  roundMaxEl.textContent = String(ROUND_MAX_VAL);
  roundNowEl.textContent = String(roundNow);

  function newRound(isNext=false){
    if(isNext){
      roundNow = Math.min(ROUND_MAX_VAL, roundNow+1);
      roundNowEl.textContent = String(roundNow);
    }
    setTarget(randomTargetColor());
    resetShot();
    btnCapture.disabled=false;
    startTimer();
  }

  function endIfDone(){
    if(roundNow>=ROUND_MAX_VAL){
      stopTimer();
      btnCapture.disabled=true;
      judgeEl.textContent += " | 挑戰結束 🎉";
    }
  }

  /** Events **/
  btnStart.addEventListener('click', async ()=>{
    await startCamera();
    if (video.readyState >= 2){ newRound(false); btnStart.disabled=true; }
    else {
      video.addEventListener('loadedmetadata', ()=>{ newRound(false); btnStart.disabled=true; }, {once:true});
    }
  });
  btnNew.addEventListener('click', ()=>{ setTarget(randomTargetColor()); resetShot(); });
  btnCapture.addEventListener('click', ()=>{
    if(!target) return;
    const shot = captureCenterAverage(0.44);
    setShot(shot);
    const dE = ciede2000(rgbToLab(target), rgbToLab(shot));
    scoreEl.textContent = String(scoreFromDeltaE(dE));
    deltaEEl.textContent = `ΔE ${dE.toFixed(2)}`;
    judgeEl.textContent = judgeFromDeltaE(dE);
  });
  btnNext.addEventListener('click', ()=>{ newRound(true); endIfDone(); });
})();
</script>
</body>
</html>